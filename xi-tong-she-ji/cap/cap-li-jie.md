# CAP理解

> **Q：CAP中的P是指什么？**

CAP中，P的英文是Partition Tolerance，即容忍分区。这里的Partition是指Network Partition，即网络分区（但实际意义又不是字面看起来那样）。举几个例子：

* ①假设系统中有2个机器，分别为a/b， 这两台机器正常情况是联通的，在某一时间，a/b之间无法连接，即无法进行网络通信，这就是形成了网络分区。
* ②假设系统中有4个机器，分别为a/b/c/d， 这四台机器正常情况是两两互联的，在某一时间，由于一些原因，a/b可以互联，c/d可以互联，但是这两组之间无法通信，这也是形成了网络分区。
* ③假设系统中有4个机器，分别为a/b/c/d， 这四台机器正常情况是两两互联的，在某一时间，由于一些原因，a被隔离，b/c/d可以两两互联，但是a无法与b/c/d互联，这也是形成了网络分区。这种情况是实际场景中最常见的网络分区形式。

造成网络分区的原因可能是网络不通，也可能是机器挂了，也可能是机器没挂但系统服务挂了，也有可能是发生了系统服务也没挂掉，但hung住了，比如Java程序发生了较长时间的Stop The World的GC等（更多情况可阅读\[[aphyr](https://github.com/aphyr)/[**partitions-post**](https://github.com/aphyr/partitions-post)\]），这些原因通常是无法进行区分的，但是最终表现就是无法接通，所以归为一类，统称为Network Partition。在分布式系统中下，发生网络分区是大概率事件，假设对一台服务器而言，开一年必宕机一次，那么365台机器的集群必然天天宕机。

所以，在进行CAP选择中，都会设计为可以容忍网络分区，因为网络分区几乎是不可避免的，是始终会发生的事情。即在分布式系统出现网络分区时，去保证一致性C或可用性A。所以CAP的三选二，基本都是CP或AP。

> **Q：既然P必然发生，那么就只能在C和A之间二者选其一吗？**

首先，**分区虽然必然发生，但是却很少发生**，那么在系统不存在分区的情况下没什么理由牺牲C或A。

其次，C与A之间的取舍可以在同一系统内以非常细小的粒度反复发生，而每一次的决策可能因为具体的操作，乃至因为牵涉到特定的数据或用户而有所不同。

最后，C/A/P三种性质都可以在不同程度上衡量，并不是非黑即白的有或无。可用性显然是在0%到100%之间连续变化的，一致性分很多级别（强一致/弱一致/最终一致），连分区也可以细分为不同含义，如系统内的不同部分对于是否存在分区都可以有不一样的认知。

要探索这些细微的差别，就要突破传统的分区处理方式，而这是一项根本性的挑战。因为分区很少出现，CAP在大多数时候允许完美的C和A。但当分区存在或可感知其影响的情况下，就要预备一种策略去探知分区并显式处理其影响。这样的策略应分为三个步骤：探知分区发生，进入显式的分区模式以限制某些操作，启动恢复过程以恢复数据一致性并补偿分区期间发生的错误。











## 参考

[CAP理论中的P到底是什么意思？](https://www.zhihu.com/question/64778723)

[CAP理论十二年回顾："规则"变了  
](http://www.infoq.com/cn/articles/cap-twelve-years-later-how-the-rules-have-changed)  
  
  


